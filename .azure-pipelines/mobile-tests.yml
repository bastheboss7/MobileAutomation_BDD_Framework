# Azure DevOps Pipeline for Mobile BDD Tests
# Supports Android and iOS testing with Appium

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - main

parameters:
  - name: platform
    displayName: 'Platform'
    type: string
    default: 'android'
    values:
      - android
      - ios
  - name: environment
    displayName: 'Environment'
    type: string
    default: 'staging'
    values:
      - local
      - staging
      - prod
  - name: tags
    displayName: 'Cucumber Tags'
    type: string
    default: '@Smoke'

variables:
  JAVA_VERSION: '21'
  NODE_VERSION: '20'
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'

stages:
  # ============================================================================
  # Build Stage
  # ============================================================================
  - stage: Build
    displayName: 'Build & Validate'
    jobs:
      - job: BuildJob
        displayName: 'Compile Project'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Setup Java $(JAVA_VERSION)'
            inputs:
              versionSpec: '$(JAVA_VERSION)'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - task: Cache@2
            displayName: 'Cache Maven packages'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
              path: $(MAVEN_CACHE_FOLDER)
          
          - task: Maven@3
            displayName: 'Compile Project'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean compile test-compile'
              options: '-q $(MAVEN_OPTS)'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(JAVA_VERSION)'

  # ============================================================================
  # Android Test Stage
  # ============================================================================
  - stage: TestAndroid
    displayName: 'Android Tests'
    dependsOn: Build
    condition: eq('${{ parameters.platform }}', 'android')
    jobs:
      - job: AndroidTest
        displayName: 'Run Android Tests'
        pool:
          vmImage: 'macos-latest'
        
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Setup Java'
            inputs:
              versionSpec: '$(JAVA_VERSION)'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: '$(NODE_VERSION)'
          
          - script: |
              npm install -g appium
              appium driver install uiautomator2
            displayName: 'Install Appium'
          
          - script: |
              echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-33;google_apis;x86_64"
              echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd -n test_emulator -k "system-images;android-33;google_apis;x86_64" --force
            displayName: 'Create Android Emulator'
          
          - script: |
              $ANDROID_HOME/emulator/emulator -avd test_emulator -no-audio -no-window -gpu swiftshader_indirect &
              adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
            displayName: 'Start Android Emulator'
          
          - script: |
              appium &
              sleep 10
            displayName: 'Start Appium Server'
          
          - task: Maven@3
            displayName: 'Run Android Tests'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'test'
              options: '-Dplatform=android -Denv=${{ parameters.environment }} -Dcucumber.filter.tags="${{ parameters.tags }}" $(MAVEN_OPTS)'
            continueOnError: true
          
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/TEST-*.xml'
              searchFolder: '$(System.DefaultWorkingDirectory)/target/surefire-reports'
              mergeTestResults: true
              failTaskOnFailedTests: true
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Reports'
            condition: always()
            inputs:
              pathToPublish: 'target/extent-reports'
              artifactName: 'AndroidTestReports'

  # ============================================================================
  # iOS Test Stage
  # ============================================================================
  - stage: TestiOS
    displayName: 'iOS Tests'
    dependsOn: Build
    condition: eq('${{ parameters.platform }}', 'ios')
    jobs:
      - job: iOSTest
        displayName: 'Run iOS Tests'
        pool:
          vmImage: 'macos-latest'
        
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Setup Java'
            inputs:
              versionSpec: '$(JAVA_VERSION)'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: '$(NODE_VERSION)'
          
          - script: |
              npm install -g appium
              appium driver install xcuitest
            displayName: 'Install Appium'
          
          - script: |
              SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 15" | head -1 | grep -oE '[0-9A-F-]{36}')
              xcrun simctl boot $SIMULATOR_ID || true
              echo "##vso[task.setvariable variable=SIMULATOR_UDID]$SIMULATOR_ID"
            displayName: 'Boot iOS Simulator'
          
          - script: |
              appium &
              sleep 10
            displayName: 'Start Appium Server'
          
          - task: Maven@3
            displayName: 'Run iOS Tests'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'test'
              options: '-Dplatform=ios -Denv=${{ parameters.environment }} -Dcucumber.filter.tags="${{ parameters.tags }}" -DiosUdid=$(SIMULATOR_UDID) $(MAVEN_OPTS)'
            continueOnError: true
          
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/TEST-*.xml'
              searchFolder: '$(System.DefaultWorkingDirectory)/target/surefire-reports'
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Reports'
            condition: always()
            inputs:
              pathToPublish: 'target/extent-reports'
              artifactName: 'iOSTestReports'
