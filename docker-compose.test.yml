# Docker Compose for running tests against Appium Grid
# Usage: docker-compose -f docker-compose.test.yml up --abort-on-container-exit

version: '3.8'

services:
  # ============================================================================
  # Test Runner
  # ============================================================================
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mobile-test-runner
    environment:
      - PLATFORM=${PLATFORM:-android}
      - ENV=${ENV:-staging}
      - CUCUMBER_TAGS=${CUCUMBER_TAGS:-@Smoke}
      - APPIUM_HUB=http://appium-android-1:4723
    volumes:
      - ./target:/app/target
    depends_on:
      appium-android-1:
        condition: service_started
      android-emulator:
        condition: service_healthy
    networks:
      - appium-grid

  # ============================================================================
  # Appium Server
  # ============================================================================
  appium-android-1:
    image: appium/appium:v2.4.1
    container_name: appium-android-1
    ports:
      - "4723:4723"
    environment:
      - APPIUM_HOST=0.0.0.0
      - APPIUM_PORT=4723
      - RELAXED_SECURITY=true
    volumes:
      - ./app:/app:ro
    networks:
      - appium-grid
    command: >
      appium --address 0.0.0.0 --port 4723 --relaxed-security --allow-insecure chromedriver_autodownload

  # ============================================================================
  # Android Emulator
  # ============================================================================
  android-emulator:
    image: budtmo/docker-android:emulator_13.0
    container_name: android-emulator
    ports:
      - "6080:6080"
    environment:
      - EMULATOR_DEVICE=Samsung Galaxy S10
      - WEB_VNC=true
    privileged: true
    networks:
      - appium-grid
    healthcheck:
      test: [ "CMD", "adb", "devices" ]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s

networks:
  appium-grid:
    driver: bridge
